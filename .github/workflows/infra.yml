name: Infrastructure

on:
  workflow_dispatch:
  pull_request:
    branches: [main]
    paths:
      - 'deploy/infra/**'
      - '.github/workflows/infra.yml'
  push:
    branches: [main]
    paths:
      - 'deploy/infra/**'
      - '.github/workflows/infra.yml'

# Cancel in-progress runs when a new one is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  TERRAFORM_VERSION: "1.9.0"

jobs:
  terraform-validate:
    name: Terraform Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # OIDC scaffolding for future Workload Identity Federation
    # Currently not used, but structure is ready for when we need it
    permissions:
      id-token: write  # Required for OIDC token
      contents: read   # Required for checkout
      pull-requests: write  # Required for PR comments

    defaults:
      run:
        working-directory: deploy/infra

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Cache Terraform plugins
        uses: actions/cache@v4
        with:
          path: |
            deploy/infra/.terraform
            ~/.terraform.d/plugin-cache
          key: terraform-${{ runner.os }}-${{ hashFiles('deploy/infra/.terraform.lock.hcl') }}
          restore-keys: |
            terraform-${{ runner.os }}-

      - name: Terraform Format Check
        id: fmt
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Terraform Init (Local Backend)
        id: init
        run: |
          # Use local backend for validation only - no remote state access needed
          terraform init -backend=false

      - name: Terraform Validate
        id: validate
        run: terraform validate -no-color

      - name: Terraform Plan (Dry Run)
        id: plan
        run: |
          # Plan without backend to check syntax/config
          # This is a dry run - no actual infrastructure changes
          terraform plan -no-color -input=false || true
        continue-on-error: true

      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          FMT_OUTCOME: ${{ steps.fmt.outcome }}
          INIT_OUTCOME: ${{ steps.init.outcome }}
          VALIDATE_OUTCOME: ${{ steps.validate.outcome }}
          PLAN_OUTCOME: ${{ steps.plan.outcome }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const output = `#### Terraform Format and Style üñå \`${process.env.FMT_OUTCOME}\`
            #### Terraform Initialization ‚öôÔ∏è \`${process.env.INIT_OUTCOME}\`
            #### Terraform Validation ü§ñ \`${process.env.VALIDATE_OUTCOME}\`
            #### Terraform Plan üìñ \`${process.env.PLAN_OUTCOME}\`

            *Pusher: @${{ github.actor }}, Action: \`${{ github.event_name }}\`, Workflow: \`${{ github.workflow }}\`*`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: output
            })

      - name: Check Results
        run: |
          echo "Format check: ${{ steps.fmt.outcome }}"
          echo "Init: ${{ steps.init.outcome }}"
          echo "Validate: ${{ steps.validate.outcome }}"
          echo "Plan: ${{ steps.plan.outcome }}"

          if [[ "${{ steps.validate.outcome }}" != "success" ]]; then
            echo "‚ùå Terraform validation failed"
            exit 1
          fi

          if [[ "${{ steps.fmt.outcome }}" != "success" ]]; then
            echo "‚ö†Ô∏è  Terraform format check failed - run 'terraform fmt -recursive' locally"
            exit 1
          fi

          echo "‚úÖ Infrastructure validation passed"

  security-scan:
    name: Infrastructure Security Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: deploy/infra
          soft_fail: true  # Don't fail the build, but show issues

      - name: Run Checkov
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: deploy/infra
          framework: terraform
          soft_fail: true  # Don't fail the build, but show issues
          output_format: cli
          download_external_modules: false

  infra-summary:
    name: Infrastructure Summary
    runs-on: ubuntu-latest
    needs: [terraform-validate, security-scan]
    if: always()

    steps:
      - name: Check job statuses
        run: |
          if [[ "${{ needs.terraform-validate.result }}" != "success" ]]; then
            echo "‚ùå Terraform validation failed"
            exit 1
          fi

          if [[ "${{ needs.security-scan.result }}" != "success" ]]; then
            echo "‚ö†Ô∏è  Security scan had issues (may be expected)"
          fi

          echo "‚úÖ Infrastructure validation completed successfully"
